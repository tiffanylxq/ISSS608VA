---
title: "In Class Ex 05"
description: "Visualising and Analysing Time-oriented Data with R"|

author:
  - name: XiaoQi
    affiliation: School of Computing and Information Systems (SMU)
date: "`r Sys.Date()`"
output: distill::distill_article
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      eval = TRUE,
                      warning = FALSE,
                      message = FALSE,
                      fig.retina = 3) #default is 1
```
y
# Getting Started

## Setting up R packages

To start with, need neccessary packages are launched using `library()`.

```{r}
packages = c('scales', 'viridis', 
             'lubridate', 'ggthemes', 
             'gridExtra', 'tidyverse', 
             'readxl', 'knitr',
             'data.table', 'ViSiElse')
for (p in packages){
  if(!require(p, character.only = T)){
    install.packages(p)
  }
  library(p,character.only = T)
}
```

## Importing Data

```{r}
attacks <- read_csv("data/eventlog.csv")

```
## Examining the data structure


**kable()** can be used to review the structure of the imported data frame.

```{r}
kable(head(attacks))
```
# Data Preparation

Step 1: Deriving weekday and hour of day fields

```{r}
make_hr_wkday <- function(ts, sc, tz) {
  #real_times is created due to different time zone 
  real_times <- ymd_hms(ts, 
                        tz = tz[1], 
                        quiet = TRUE)
  dt <- data.table(source_country = sc,
                   wkday = weekdays(real_times),
                   hour = hour(real_times))
  return(dt)
  }
```

Step 2: Deriving the attacks tibble data frame

```{r}
wkday_levels <- c('Saturday', 'Friday', 
                  'Thursday', 'Wednesday', 
                  'Tuesday', 'Monday', 
                  'Sunday')
attacks <- attacks %>%
  group_by(tz) %>%
  do(make_hr_wkday(.$timestamp, 
                   .$source_country, 
                   .$tz)) %>% 
  ungroup() %>% 
  mutate(wkday = factor(
    wkday, levels = wkday_levels),
    hour  = factor(
      hour, levels = 0:23))
```

```{r}
grouped <- attacks %>% 
  count(wkday, hour) %>% 
  ungroup() %>%
  na.omit() #there is missing value, so without 

ggplot(grouped, 
       aes(hour, 
           wkday, 
           fill = n)) + 
geom_tile(color = "white", 
          size = 0.1) + 
theme_tufte(base_family = "Helvetica") + 
coord_equal() +
scale_fill_gradient(name = "# of attacks",
                    low = "sky blue", 
                    high = "dark blue") +
labs(x = NULL, 
     y = NULL, 
     title = "Attacks by weekday and time of day") +
theme(axis.ticks = element_blank(),
      plot.title = element_text(hjust = 0.5),
      legend.title = element_text(size = 8),
      legend.text = element_text(size = 6) )

```

```{r}
data("typDay")
visielse(typDay)
```

```{r}
visielse(typDay, informer = NULL)

```
```{r}
p1 <- visielse(typDay, informer = NULL)
b1 <- ConvertFromViSibook(p1@book) #grab object and make into datatable; p: puntual, l: long 
```
